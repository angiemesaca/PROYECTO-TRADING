{% extends "base.html" %}

{% block title %}Dashboard - Wallet Trainer{% endblock %}

{% block content %}

<!-- Mensaje de Bienvenida -->
<div class="mb-4">
    <h1 class="display-5 fw-bold text-white">Bienvenido, {{ profile.username }}</h1>
    <p class="fs-4 text-white-50">Este es tu panel de control. ¿Listo para operar?</p>
</div>

<div class="row g-4">
    
    <!-- Columna Izquierda (Control y Mercado) -->
    <div class="col-lg-8">
        
        <!-- Tarjeta: Control del Bot -->
        <div class="card bg-dark text-white shadow-sm mb-4 border-secondary">
            <div class="card-header bg-secondary-subtle text-white-50 fw-bold">
                <i class="bi bi-robot"></i>
                Control del Bot
            </div>
            <div class="card-body p-4">
                <p class="card-text text-white-50">Activa o desactiva tu estrategia automatizada.</p>
                <div class="row mb-3">
                    <div class="col-6">
                        <span class="text-white-50">Estado Actual:</span>
                        {% if settings.isActive %}
                            <strong class="text-success d-block fs-5">Activo</strong>
                        {% else %}
                            <strong class="text-danger d-block fs-5">Inactivo</strong>
                        {% endif %}
                    </div>
                    <div class="col-6">
                        <span class="text-white-50">Estrategia Actual:</span>
                        <strong class="text-primary-emphasis d-block fs-5">
                            Operando en: 
                            <span class="text-decoration-underline">{{ settings.activo|replace('_', ' ')|upper }}</span>
                        </strong>
                    </div>
                </div>

                {% if settings.isActive %}
                    <form action="{{ url_for('deactivate_bot') }}" method="POST">
                        <button type="submit" class="btn btn-danger btn-lg w-100">
                            <i class="bi bi-stop-circle"></i> 
                            Desactivar Bot
                        </button>
                    </form>
                {% else %}
                    <form action="{{ url_for('activate_bot') }}" method="POST">
                        <button type="submit" class="btn btn-success btn-lg w-100">
                            <i class="bi bi-play-circle"></i> 
                            Activar Bot
                        </button>
                    </form>
                {% endif %}
                <div class="form-text text-center mt-2 text-white-50">
                    <small>El bot ejecutará operaciones según tu perfil de riesgo.</small>
                </div>
            </div>
        </div>

        <!-- Tarjeta: Mercado en Vivo -->
        <div class="card bg-dark text-white shadow-sm border-secondary">
            <div class="card-header bg-secondary-subtle text-white-50 fw-bold">
                <i class="bi bi-graph-up"></i>
                Mercado en Vivo
            </div>
            <div class="card-body p-4">
                <h5 class="card-title text-white mb-3">
                    Gráfica en tiempo real: 
                    <span class="text-info">{{ settings.activo|replace('_', ' ')|title }}</span>
                </h5>
                
                <div id="tv-mini-chart-widget-container" style="height: 400px; width: 100%;">
                    <div class="tradingview-widget-container__widget" style="height:100%;width:100%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Columna Derecha (Análisis IA) -->
    <div class="col-lg-4">
        <div class="card bg-dark text-white shadow-sm border-secondary h-100">
            <div class="card-header bg-secondary-subtle text-white-50 fw-bold">
                <i class="bi bi-magic"></i>
                Análisis IA (Simulado)
            </div>
            <div class="card-body p-4 d-flex flex-column">
                <h5 class="card-title text-white">Visión de Mercado</h5>
                
                <p class="text-white-50 small mb-3">
                    Nuestro algoritmo analiza tendencias, volumen y sentimiento para darte una ventaja competitiva.
                </p>

                <div class="bg-black bg-opacity-25 p-3 rounded mb-3 border border-secondary">
                    <small class="text-muted d-block mb-1">Perfil de Riesgo:</small>
                    <strong class="text-{{ 'success' if settings.riesgo == 'bajo' else 'warning' if settings.riesgo == 'medio' else 'danger' }}">
                        {{ settings.riesgo | upper }}
                    </strong>
                </div>
                
                <p class="text-white-50 small">
                    ¿Quieres saber qué opina la IA sobre <strong>{{ settings.activo|replace('_', ' ')|title }}</strong> hoy?
                </p>
                
                <div class="mt-auto"> 
                    <a href="{{ url_for('sugerencias') }}" class="btn btn-outline-info w-100">
                        <i class="bi bi-search"></i> Ver Análisis Completo
                    </a>
                </div>
            </div>
        </div>
    </div>
    
</div>

{% endblock %}

{% block page_scripts %}
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script type="text/javascript">
    
    // Función mejorada para soportar los nuevos activos
    function getTradingViewSymbol(assetName) {
        if (!assetName) return "BINANCE:BTCUSD";

        // Criptos
        if (assetName.includes("crypto_btc")) return "BINANCE:BTCUSD";
        if (assetName.includes("crypto_eth")) return "BINANCE:ETHUSD";
        if (assetName.includes("crypto_sol")) return "BINANCE:SOLUSD";
        if (assetName.includes("crypto_ada")) return "BINANCE:ADAUSD";
        
        // Forex
        if (assetName.includes("forex_eur_usd")) return "FX:EURUSD";
        if (assetName.includes("forex_usd_jpy")) return "FX:USDJPY";
        if (assetName.includes("forex_gbp_usd")) return "FX:GBPUSD";
        
        // Stocks / Indices
        if (assetName.includes("stock_tsla")) return "NASDAQ:TSLA";
        if (assetName.includes("stock_aapl")) return "NASDAQ:AAPL";
        if (assetName.includes("index_spx")) return "SP:SPX";
        if (assetName.includes("index_ndx")) return "NASDAQ:NDX";
        
        // Commodities
        if (assetName.includes("commodity_oro")) return "OANDA:XAUUSD";
        
        return "BINANCE:BTCUSD";
    }

    const currentAsset = {{ settings.activo | tojson }};
    const tvSymbol = getTradingViewSymbol(currentAsset);

    new TradingView.widget({
      "width": "100%",
      "height": 400,
      "symbol": tvSymbol,
      "interval": "D",
      "timezone": "Etc/UTC",
      "theme": "dark",
      "style": "1",
      "locale": "es",
      "enable_publishing": false,
      "allow_symbol_change": false,
      "container_id": "tv-mini-chart-widget-container"
    });
</script>
{% endblock %}