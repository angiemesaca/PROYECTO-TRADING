{% extends "base.html" %}

{% block title %}Terminal - Wallet Trainer{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold text-white mb-0">Panel de Control</h2>
        <p class="text-secondary mb-0">Bienvenido, <span class="text-warning">{{ profile.username }}</span></p>
    </div>
    
    <form action="{{ url_for('bot_settings') }}" method="POST" class="d-flex gap-2">
        <input type="hidden" name="riesgo" value="{{ settings.riesgo }}">
        <input type="hidden" name="indicadores" value="{{ settings.indicadores }}">
        <input type="hidden" name="horario" value="{{ settings.horario }}">
        
        <select name="activo" class="form-select form-select-sm bg-dark text-white border-secondary" onchange="this.form.submit()">
            <optgroup label="Criptomonedas">
                <option value="crypto_btc_usd" {% if settings.activo == 'crypto_btc_usd' %}selected{% endif %}>Bitcoin (BTC)</option>
                <option value="crypto_eth_usd" {% if settings.activo == 'crypto_eth_usd' %}selected{% endif %}>Ethereum (ETH)</option>
                <option value="crypto_sol_usd" {% if settings.activo == 'crypto_sol_usd' %}selected{% endif %}>Solana (SOL)</option>
            </optgroup>
            
            <optgroup label="Empresas Colombia (ADR)">
                <option value="stock_ecopetrol" {% if settings.activo == 'stock_ecopetrol' %}selected{% endif %}>Ecopetrol (EC)</option>
                <option value="stock_bancolombia" {% if settings.activo == 'stock_bancolombia' %}selected{% endif %}>Bancolombia (CIB)</option>
                <option value="stock_aval" {% if settings.activo == 'stock_aval' %}selected{% endif %}>Grupo Aval (AVAL)</option>
            </optgroup>

            <optgroup label="Mercado Global">
                <option value="stock_tsla" {% if settings.activo == 'stock_tsla' %}selected{% endif %}>Tesla (TSLA)</option>
                <option value="stock_aapl" {% if settings.activo == 'stock_aapl' %}selected{% endif %}>Apple (AAPL)</option>
                <option value="stock_nubank" {% if settings.activo == 'stock_nubank' %}selected{% endif %}>NuBank (NU)</option>
                <option value="forex_eur_usd" {% if settings.activo == 'forex_eur_usd' %}selected{% endif %}>EUR / USD</option>
                <option value="commodity_oro" {% if settings.activo == 'commodity_oro' %}selected{% endif %}>Oro (Gold)</option>
            </optgroup>
        </select>
    </form>
</div>

<div class="row g-4">
    
    <div class="col-lg-9">
        <div class="card h-100 bg-dark border-secondary">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                <span><i class="bi bi-activity text-warning me-2"></i>Mercado en Vivo: <span class="text-white fw-bold">{{ settings.activo.split('_')[-1]|upper }}</span></span>
                <span class="badge bg-secondary">Precio Actual: ${{ "%.2f"|format(settings.current_price|float) }}</span>
            </div>
            <div class="card-body p-0">
                <div id="tv-mini-chart-widget-container" style="height: 500px; width: 100%; border-radius: 0 0 8px 8px;"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-3">
        
        <div class="card mb-3 bg-dark border-secondary">
            <div class="card-header border-secondary">
                <i class="bi bi-cpu"></i> Motor de Trading
            </div>
            <div class="card-body text-center">
                
                <div class="mb-3">
                    <span class="d-block text-secondary small mb-1">ESTADO ACTUAL</span>
                    {% if settings.isActive %}
                        <div class="status-indicator">
                            <span class="dot active"></span> Ejecutando
                        </div>
                    {% else %}
                        <div class="status-indicator">
                            <span class="dot inactive"></span> Detenido
                        </div>
                    {% endif %}
                </div>

                <div class="row g-2 mb-4">
                    <div class="col-6">
                        <div class="metric-box">
                            <div class="metric-label">Activo</div>
                            <div class="metric-value text-info">
                                {{ settings.activo.split('_')[-1]|upper if '_' in settings.activo else 'BTC' }}
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-box">
                            <div class="metric-label">Riesgo</div>
                            {% set risk_class = 'success' if settings.riesgo == 'bajo' else 'warning' if settings.riesgo == 'medio' else 'danger' %}
                            <div class="metric-value text-{{ risk_class }}">
                                {{ settings.riesgo|upper }}
                            </div>
                        </div>
                    </div>
                </div>

                {% if settings.isActive %}
                    <form action="{{ url_for('deactivate_bot') }}" method="POST">
                        <button type="submit" class="btn btn-danger-custom w-100 py-2 fw-bold shadow-sm">
                            <i class="bi bi-power me-2"></i> APAGAR BOT
                        </button>
                    </form>
                {% else %}
                    <form action="{{ url_for('activate_bot') }}" method="POST">
                        <button type="submit" class="btn btn-success-custom w-100 py-2 fw-bold shadow-sm">
                            <i class="bi bi-play-circle-fill me-2"></i> ENCENDER BOT
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>

        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary pb-0">
                <i class="bi bi-robot text-primary"></i> Análisis IA
            </div>
            <div class="card-body">
                <p class="small text-secondary mb-3">
                    Basado en tus parámetros de riesgo y el activo seleccionado.
                </p>
                
                <div class="p-3 rounded bg-black border border-secondary mb-3">
                    <h6 class="text-white mb-1"><i class="bi bi-terminal me-2 text-warning"></i>Sugerencia:</h6>
                    <div class="mb-0 small text-light font-monospace">
                        {{ ai_snippet | safe }}
                    </div>
                </div>

                <a href="{{ url_for('sugerencias') }}" class="btn btn-outline-primary btn-sm w-100">
                    Ver Análisis Completo
                </a>
            </div>
        </div>

    </div>
</div>

{% endblock %}

{% block page_scripts %}
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script type="text/javascript">
    const currentAsset = "{{ settings.activo if settings and settings.activo else 'crypto_btc_usd' }}";
    
    function getTradingViewSymbol(assetName) {
        if (!assetName) return "BINANCE:BTCUSDT";
        const lower = assetName.toLowerCase();

        // Colombia (NYSE ADRs)
        if (lower.includes("ecopetrol")) return "NYSE:EC";
        if (lower.includes("bancolombia")) return "NYSE:CIB";
        if (lower.includes("aval")) return "NYSE:AVAL";
        if (lower.includes("nubank")) return "NYSE:NU";

        // Criptos
        if (lower.includes("btc")) return "BINANCE:BTCUSDT";
        if (lower.includes("eth")) return "BINANCE:ETHUSDT";
        if (lower.includes("sol")) return "BINANCE:SOLUSDT";
        
        // ... (El resto sigue igual: Stocks, Forex, etc.) ...
        if (lower.includes("tsla")) return "NASDAQ:TSLA";
        if (lower.includes("aapl")) return "NASDAQ:AAPL";
        if (lower.includes("eur")) return "FX:EURUSD";
        if (lower.includes("oro") || lower.includes("gold")) return "OANDA:XAUUSD";
        
        return "BINANCE:BTCUSDT";
    }

    const tvSymbol = getTradingViewSymbol(currentAsset);

    new TradingView.widget({
      "autosize": true,
      "symbol": tvSymbol,
      "interval": "D",
      "timezone": "America/New_York",
      "theme": "dark",
      "style": "1",
      "locale": "es",
      "toolbar_bg": "#f1f3f6",
      "enable_publishing": false,
      "hide_top_toolbar": false,
      "hide_legend": false,
      "save_image": false,
      "container_id": "tv-mini-chart-widget-container",
      "backgroundColor": "#1e2329"
    });
</script>
{% endblock %}