{% extends "base.html" %}

{% block title %}Dashboard - Wallet Trainer{% endblock %}

{% block content %}

<!-- Animaci√≥n de entrada suave -->
<div class="animate-fade-in-up">

    <!-- Encabezado de Bienvenida -->
    <div class="mb-8 flex justify-between items-end">
        <div>
            <h1 class="text-4xl font-bold text-white mb-2">Hola, {{ profile.username }} üëã</h1>
            <p class="text-gray-400 text-lg">Aqu√≠ est√° el resumen de tu estrategia hoy.</p>
        </div>
        <div class="hidden md:block">
            <span class="px-4 py-2 rounded-full bg-gray-800 border border-gray-700 text-sm text-gray-300 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                Sistema Operativo
            </span>
        </div>
    </div>

    <!-- Grid Principal -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Columna Izquierda (2/3): Gr√°fico y Control -->
        <div class="lg:col-span-2 space-y-8">
            
            <!-- Tarjeta: Gr√°fico de TradingView -->
            <div class="bg-gray-800 rounded-2xl shadow-xl border border-gray-700 overflow-hidden">
                <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-white flex items-center gap-2">
                        <!-- Icono de Gr√°fico -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                        Mercado en Vivo: <span class="text-blue-400">{{ settings.activo|replace('_', ' ')|title }}</span>
                    </h2>
                </div>
                <div class="h-[450px] w-full bg-gray-900" id="tradingview_widget">
                    <!-- El widget se inyectar√° aqu√≠ -->
                </div>
            </div>

            <!-- Tarjeta: Control del Bot -->
            <div class="bg-gray-800 rounded-2xl shadow-xl border border-gray-700 p-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-2">Estado del Bot</h2>
                        <div class="flex items-center gap-3">
                            <div class="px-3 py-1 rounded-md bg-gray-900 border border-gray-700">
                                <span class="text-gray-400 text-sm">Estrategia:</span>
                                <span class="text-white font-medium ml-1">{{ settings.riesgo|capitalize }}</span>
                            </div>
                            {% if settings.isActive %}
                                <div class="px-3 py-1 rounded-md bg-green-900/30 border border-green-700/50">
                                    <span class="text-green-400 font-bold flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> ACTIVO
                                    </span>
                                </div>
                            {% else %}
                                <div class="px-3 py-1 rounded-md bg-red-900/30 border border-red-700/50">
                                    <span class="text-red-400 font-bold flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full bg-red-500"></span> INACTIVO
                                    </span>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Botones Grandes -->
                    <div class="w-full md:w-auto">
                        {% if settings.isActive %}
                            <form action="{{ url_for('deactivate_bot') }}" method="POST">
                                <button type="submit" class="w-full md:w-auto px-8 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-lg shadow-red-900/20 transition-all transform hover:scale-105 active:scale-95 flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
                                    DETENER BOT
                                </button>
                            </form>
                        {% else %}
                            <form action="{{ url_for('activate_bot') }}" method="POST">
                                <button type="submit" class="w-full md:w-auto px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg shadow-green-900/20 transition-all transform hover:scale-105 active:scale-95 flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                                    ACTIVAR BOT
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>

        </div>

        <!-- Columna Derecha (1/3): IA y Noticias -->
        <div class="space-y-8">
            
            <!-- Tarjeta: An√°lisis R√°pido de IA -->
            <div class="bg-gray-800 rounded-2xl shadow-xl border border-gray-700 p-6 relative overflow-hidden group">
                <!-- Efecto de brillo de fondo -->
                <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-blue-500 rounded-full opacity-10 blur-xl group-hover:opacity-20 transition-opacity"></div>
                
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                    Insights de IA
                </h2>

                <div class="bg-gray-900/50 rounded-xl p-4 border border-gray-700/50 mb-4 min-h-[120px]">
                    {% if ai_snippet and 'Error:' not in ai_snippet %}
                        <p class="text-gray-300 text-sm leading-relaxed">
                            {{ ai_snippet|truncate(150, True, '...')|replace('\n', '<br>')|safe }}
                        </p>
                    {% elif 'Error:' in ai_snippet %}
                        <p class="text-red-400 text-sm">IA no disponible temporalmente.</p>
                    {% else %}
                        <p class="text-gray-500 text-sm italic">Esperando datos del mercado...</p>
                    {% endif %}
                </div>

                <a href="{{ url_for('sugerencias') }}" class="block w-full text-center py-2 rounded-lg border border-purple-500/30 text-purple-400 hover:bg-purple-500/10 transition-colors text-sm font-medium">
                    Ver An√°lisis Completo
                </a>
            </div>

            <!-- Tarjeta: Noticias Recientes (Simuladas) -->
            <div class="bg-gray-800 rounded-2xl shadow-xl border border-gray-700 p-6">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    Noticias Relevantes
                </h2>
                <div class="space-y-4">
                    <!-- Noticia 1 -->
                    <div class="flex gap-3 items-start">
                        <div class="min-w-[4px] h-full bg-green-500 rounded-full mt-1"></div>
                        <div>
                            <h4 class="text-white text-sm font-medium hover:text-blue-400 cursor-pointer transition-colors">Bitcoin rompe resistencia clave</h4>
                            <p class="text-gray-500 text-xs mt-1">Hace 2 horas ‚Ä¢ CoinDesk</p>
                        </div>
                    </div>
                    <!-- Noticia 2 -->
                    <div class="flex gap-3 items-start">
                        <div class="min-w-[4px] h-full bg-red-500 rounded-full mt-1"></div>
                        <div>
                            <h4 class="text-white text-sm font-medium hover:text-blue-400 cursor-pointer transition-colors">Volatilidad esperada por anuncios de la FED</h4>
                            <p class="text-gray-500 text-xs mt-1">Hace 5 horas ‚Ä¢ Bloomberg</p>
                        </div>
                    </div>
                    <!-- Noticia 3 -->
                    <div class="flex gap-3 items-start">
                        <div class="min-w-[4px] h-full bg-blue-500 rounded-full mt-1"></div>
                        <div>
                            <h4 class="text-white text-sm font-medium hover:text-blue-400 cursor-pointer transition-colors">Nuevo m√°ximo hist√≥rico en usuarios de DeFi</h4>
                            <p class="text-gray-500 text-xs mt-1">Hace 8 horas ‚Ä¢ Decrypt</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

</div>

<!-- Scripts para TradingView -->
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // Mapeo de activos de tu configuraci√≥n a s√≠mbolos de TradingView
        const symbolMap = {
            'crypto_btc_usd': 'BINANCE:BTCUSD',
            'crypto_eth_usd': 'BINANCE:ETHUSD',
            'crypto_sol_usd': 'BINANCE:SOLUSD',
            'forex_eur_usd': 'FX:EURUSD',
            'commodity_oro': 'OANDA:XAUUSD',
            'index_spx_500': 'SP:SPX'
        };

        // Obtenemos el activo actual desde Flask
        const currentAssetKey = "{{ settings.activo }}";
        // Si no est√° en el mapa, usamos BTC por defecto
        const tvSymbol = symbolMap[currentAssetKey] || 'BINANCE:BTCUSD';

        new TradingView.widget({
            "autosize": true,
            "symbol": tvSymbol,
            "interval": "D",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "1",
            "locale": "es",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "allow_symbol_change": false,
            "container_id": "tradingview_widget",
            "hide_side_toolbar": false,
            "studies": [
                "RSI@tv-basicstudies",  // A√±adimos RSI porque tu bot lo usa
                "MACD@tv-basicstudies"  // A√±adimos MACD
            ]
        });
    });
</script>

<!-- Estilos para animaci√≥n simple -->
<style>
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translate3d(0, 20px, 0);
        }
        to {
            opacity: 1;
            transform: translate3d(0, 0, 0);
        }
    }
    .animate-fade-in-up {
        animation: fadeInUp 0.5s ease-out forwards;
    }
</style>

{% endblock %}