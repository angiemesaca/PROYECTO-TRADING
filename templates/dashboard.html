{% extends "base.html" %}

{% block title %}Terminal - Wallet Trainer{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold text-white mb-0">Panel de Control</h2>
        <p class="text-secondary mb-0">Bienvenido, <span class="text-warning">{{ profile.username }}</span></p>
    </div>
    <a href="{{ url_for('bot_settings') }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-gear-fill"></i> Configuración
    </a>
</div>

<div class="row g-4">
    
    <div class="col-lg-9">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-activity text-warning me-2"></i>Mercado en Vivo: {{ settings.activo|replace('_', ' ')|upper }}</span>
                <span class="badge bg-dark border border-secondary text-secondary">1D Timeframe</span>
            </div>
            <div class="card-body p-0">
                <div id="tv-mini-chart-widget-container" style="height: 500px; width: 100%; border-radius: 0 0 8px 8px;"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-3">
        
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-cpu"></i> Motor de Trading
            </div>
            <div class="card-body text-center">
                
                <div class="mb-3">
                    <span class="d-block text-secondary small mb-1">ESTADO ACTUAL</span>
                    {% if settings.isActive %}
                        <div class="status-indicator">
                            <span class="dot active"></span> Ejecutando
                        </div>
                    {% else %}
                        <div class="status-indicator">
                            <span class="dot inactive"></span> Detenido
                        </div>
                    {% endif %}
                </div>

                <div class="row g-2 mb-4">
                    <div class="col-6">
                        <div class="metric-box">
                            <div class="metric-label">Activo</div>
                            <div class="metric-value text-info">
                                {{ settings.activo.split('_')[-1]|upper if '_' in settings.activo else 'BTC' }}
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-box">
                            <div class="metric-label">Riesgo</div>
                            
                            {% set risk_class = 'success' if settings.riesgo == 'bajo' else 'warning' if settings.riesgo == 'medio' else 'danger' %}
                            
                            <div class="metric-value text-{{ risk_class }}">
                                {{ settings.riesgo|upper }}
                            </div>
                        </div>
                    </div>
                </div>

                {% if settings.isActive %}
                    <form action="{{ url_for('deactivate_bot') }}" method="POST">
                        <button type="submit" class="btn btn-danger-custom w-100 py-2 fw-bold shadow-sm">
                            <i class="bi bi-power me-2"></i> APAGAR BOT
                        </button>
                    </form>
                {% else %}
                    <form action="{{ url_for('activate_bot') }}" method="POST">
                        <button type="submit" class="btn btn-success-custom w-100 py-2 fw-bold shadow-sm">
                            <i class="bi bi-play-circle-fill me-2"></i> ENCENDER BOT
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header border-0 pb-0">
                <i class="bi bi-robot text-primary"></i> Análisis IA
            </div>
            <div class="card-body">
                <p class="small text-secondary mb-3">
                    Basado en tus parámetros de riesgo y el activo seleccionado.
                </p>
                
                <div class="p-3 rounded bg-dark border border-secondary mb-3">
                    <h6 class="text-white mb-1"><i class="bi bi-chat-square-quote-fill me-2 text-warning"></i>Sugerencia:</h6>
                    <p class="mb-0 small fst-italic text-light">
                        "{{ ai_snippet if ai_snippet else 'Análisis pendiente...' }}"
                    </p>
                </div>

                <a href="{{ url_for('sugerencias') }}" class="btn btn-outline-primary btn-sm w-100">
                    Ver Análisis Completo
                </a>
            </div>
        </div>

    </div>
</div>

{% endblock %}

{% block page_scripts %}
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script type="text/javascript">
    
    // --- SOLUCIÓN DEL ERROR ---
    // Usamos comillas "" por fuera para que Javascript no llore,
    // y usamos 'default' por si la base de datos no trae el dato.
    const currentAsset = "{{ settings.activo if settings and settings.activo else 'crypto_btc_usd' }}";
    
    // Debug: Muestra en la consola (F12) qué valor llegó realmente
    console.log("Activo actual recibido:", currentAsset);

    // Función para mapear tus IDs de activos a símbolos de TradingView
    function getTradingViewSymbol(assetName) {
        if (!assetName) return "BINANCE:BTCUSDT";
        
        // Convertimos a minúsculas para evitar errores
        const lower = assetName.toLowerCase();

        // Mapeo de Criptos
        if (lower.includes("btc")) return "BINANCE:BTCUSDT";
        if (lower.includes("eth")) return "BINANCE:ETHUSDT";
        if (lower.includes("sol")) return "BINANCE:SOLUSDT";
        if (lower.includes("ada")) return "BINANCE:ADAUSDT";
        
        // Mapeo de Forex
        if (lower.includes("eur")) return "FX:EURUSD";
        if (lower.includes("jpy")) return "FX:USDJPY";
        if (lower.includes("gbp")) return "FX:GBPUSD";
        
        // Mapeo de Acciones
        if (lower.includes("tsla")) return "NASDAQ:TSLA";
        if (lower.includes("aapl")) return "NASDAQ:AAPL";
        
        // Indices y Commodities
        if (lower.includes("spx")) return "OANDA:SPX500USD";
        if (lower.includes("oro") || lower.includes("gold")) return "OANDA:XAUUSD";
        
        return "BINANCE:BTCUSDT"; // Valor por defecto si no encuentra coincidencia
    }

    const tvSymbol = getTradingViewSymbol(currentAsset);

    // Inicializar Widget
    new TradingView.widget({
      "autosize": true,
      "symbol": tvSymbol,
      "interval": "D",
      "timezone": "America/New_York",
      "theme": "dark",
      "style": "1",
      "locale": "es",
      "toolbar_bg": "#f1f3f6",
      "enable_publishing": false,
      "hide_top_toolbar": false,
      "hide_legend": false,
      "save_image": false,
      "container_id": "tv-mini-chart-widget-container",
      "backgroundColor": "#1e2329"
    });
</script>
{% endblock %}