{% extends "base.html" %}

{% block title %}Dashboard - Wallet Trainer{% endblock %}

{% block content %}

<!-- Mensaje de Bienvenida -->
<div class="mb-4">
    <h1 class="display-5 fw-bold text-white">Bienvenido, {{ profile.username }}</h1>
    <p class="fs-4 text-white-50">Este es tu panel de control. ¿Listo para operar?</p>
</div>

<div class="row g-4">
    
    <!-- Columna Izquierda (Control y Mercado) -->
    <div class="col-lg-8">
        
        <!-- Tarjeta: Control del Bot -->
        <div class="card bg-dark text-white shadow-sm mb-4 border-secondary">
            <div class="card-header bg-secondary-subtle text-white-50 fw-bold">
                <i class="bi bi-robot"></i>
                Control del Bot
            </div>
            <div class="card-body p-4">
                <p class="card-text text-white-50">Activa o desactiva tu estrategia.</p>
                <div class="row mb-3">
                    <div class="col-6">
                        <span class="text-white-50">Estado Actual:</span>
                        {% if settings.isActive %}
                            <strong class="text-success d-block fs-5">Activo</strong>
                        {% else %}
                            <strong class="text-danger d-block fs-5">Inactivo</strong>
                        {% endif %}
                    </div>
                    <div class="col-6">
                        <span class="text-white-50">Estrategia Actual:</span>
                        <strong class="text-primary-emphasis d-block fs-5">
                            Buscando operaciones en 
                            <span class="text-decoration-underline">{{ settings.activo.split('_')[-2] | upper }}/{{ settings.activo.split('_')[-1] | upper }}</span>
                        </strong>
                    </div>
                </div>

                <!-- 
                  ¡BOTONES ARREGLADOS!
                  Ahora están dentro de formularios y SÍ funcionan.
                  (Ya no están "disabled").
                -->
                {% if settings.isActive %}
                    <form action="{{ url_for('deactivate_bot') }}" method="POST">
                        <button type="submit" class="btn btn-danger btn-lg w-100">
                            <i class="bi bi-stop-circle"></i> 
                            Desactivar Bot
                        </button>
                    </form>
                {% else %}
                    <form action="{{ url_for('activate_bot') }}" method="POST">
                        <button type="submit" class="btn btn-success btn-lg w-100">
                            <i class="bi bi-play-circle"></i> 
                            Activar Bot
                        </button>
                    </form>
                {% endif %}
                <div class="form-text text-center mt-2">
                    (En Modo Backtest, esto solo afecta las sugerencias de la IA)
                </div>
            </div>
        </div>

        <!-- Tarjeta: Mercado en Vivo -->
        <div class="card bg-dark text-white shadow-sm border-secondary">
            <div class="card-header bg-secondary-subtle text-white-50 fw-bold">
                <i class="bi bi-graph-up"></i>
                Mercado en Vivo
            </div>
            <div class="card-body p-4">
                <h5 class="card-title text-white">
                    Gráfica del activo seleccionado: 
                    <span class="text-primary-emphasis">{{ settings.activo.split('_')[-2] | upper }}/{{ settings.activo.split('_')[-1] | upper }}</span>
                </h5>
                
                <div id="tv-mini-chart-widget-container" style="height: 400px; width: 100%;">
                    <div class="tradingview-widget-container__widget" style="height:100%;width:100%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Columna Derecha (Análisis IA) -->
    <div class="col-lg-4">
        <div class="card bg-dark text-white shadow-sm border-secondary h-100">
            <div class="card-header bg-secondary-subtle text-white-50 fw-bold">
                <i class="bi bi-magic"></i>
                Análisis IA (Simulado)
            </div>
            <div class="card-body p-4 d-flex flex-column">
                <h5 class="card-title text-white">Sugerencia rápida para tu activo</h5>
                
                <!-- 
                  ¡PERFIL ARREGLADO!
                  Cambiamos 'profile.risk' por 'settings.riesgo'
                -->
                <p class="text-white-50 small">
                    **Análisis de Activo (Simulado):** Nuestros modelos detectan una fuerte acumulación de volumen en el activo seleccionado. El sentimiento en redes es positivo. Alta probabilidad de ruptura alcista.
                </p>
                <p class="text-white-50 small">
                    **Sugerencia (Perfil {{ settings.riesgo | capitalize }}):** Basado en tu perfil, la estrategia actual es adecuada. Considera asegurar ganancias en la próxima resistencia.
                </p>
                
                <div class="mt-auto"> <!-- Empuja el botón al fondo -->
                    <a href="{{ url_for('sugerencias') }}" class="btn btn-outline-primary w-100">
                        <i class="bi bi-search"></i> Ver análisis completo
                    </a>
                </div>
            </div>
        </div>
    </div>
    
</div>

{% endblock %}


<!-- 
  Scripts del Gráfico
-->
{% block page_scripts %}
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script type="text/javascript">
    
    // 1. Esta función traduce nuestro "activo" (ej: crypto_btc_usd)
    //    a un "símbolo" que TradingView entiende (ej: BINANCE:BTCUSD)
    function getTradingViewSymbol(assetName) {
        if (!assetName) return "BINANCE:BTCUSD"; // Default

        if (assetName.includes("crypto_btc_usd")) return "BINANCE:BTCUSD";
        if (assetName.includes("crypto_eth_usd")) return "BINANCE:ETHUSD";
        if (assetName.includes("crypto_sol_usd")) return "BINANCE:SOLUSD";
        if (assetName.includes("forex_eur_usd")) return "FX:EURUSD";
        if (assetName.includes("commodity_oro")) return "OANDA:XAUUSD";
        if (assetName.includes("index_spx_500")) return "SP:SPX";
        
        return "BINANCE:BTCUSD"; // Default si no lo encuentra
    }

    // 2. Obtenemos el activo actual de tus Ajustes
    const currentAsset = {{ settings.activo | tojson }};
    const tvSymbol = getTradingViewSymbol(currentAsset);

    // 3. Cargamos el widget de TradingView
    new TradingView.widget({
      "width": "100%",
      "height": 400,
      "symbol": tvSymbol, // ¡Aquí usamos el símbolo dinámico!
      "interval": "D",
      "timezone": "Etc/UTC",
      "theme": "dark", // Tema oscuro
      "style": "1",
      "locale": "es",
      "enable_publishing": false,
      "allow_symbol_change": false,
      "container_id": "tv-mini-chart-widget-container"
    });
</script>
{% endblock %}
```

---

### Tu Tarea

1.  **Reemplaza** tu `templates/dashboard.html` con este nuevo archivo.
2.  **Sube los cambios a GitHub:**
    ```bash
    git add templates/dashboard.html
    git commit -m "Arregla el perfil de riesgo del dashboard y habilita los botones del bot"
    git push origin main