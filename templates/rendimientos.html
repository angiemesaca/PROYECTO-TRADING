{% extends "base.html" %}

{% block title %}Rendimiento del Bot{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    
    <!-- Título -->
    <div class="flex items-center mb-6">
        <span class="text-3xl text-blue-500 mr-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-graph-up-arrow" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M0 0h1v15h15v1H0V0Zm10 3.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-1 0V4.9l-3.613 4.417a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .758-.06l2.609 2.61L13.445 4H10.5a.5.5 0 0 1-.5-.5Z"/>
            </svg>
        </span>
        <h1 class="text-3xl font-bold text-white">Rendimiento del Bot</h1>
    </div>
    <p class="text-lg text-gray-400 mb-8">Análisis de las operaciones automáticas generadas por tu estrategia.</p>

    <!--
    ¡BOTONES ELIMINADOS!
    Hemos quitado los formularios para 'generate_mock' y 'clear_history'
    para que la experiencia sea automática.
    -->

    <!-- Estadísticas Clave -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Tarjeta de Ganancia Neta -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-700">
            <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Ganancia Neta Total</h3>
            <p class="text-3xl font-bold text-white mt-2">
                ${{ "%.2f"|format(stats.ganancia_total) }}
            </p>
            {% if stats.ganancia_total > 0 %}
                <span class="text-green-500 text-sm font-medium">+${{ "%.2f"|format(stats.ganancia_total) }} vs inicio</span>
            {% elif stats.ganancia_total < 0 %}
                <span class="text-red-500 text-sm font-medium">-${{ "%.2f"|format(stats.ganancia_total|abs) }} vs inicio</span>
            {% else %}
                <span class="text-gray-500 text-sm font-medium">Sin cambios</span>
            {% endif %}
        </div>

        <!-- Tarjeta de Win Rate -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-700">
            <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Win Rate</h3>
            <p class="text-3xl font-bold text-white mt-2">{{ "%.1f"|format(stats.win_rate) }}%</p>
            <span class="text-gray-500 text-sm font-medium">{{ stats.trades_ganadores }} de {{ stats.total_trades }} trades</span>
        </div>

        <!-- Tarjeta de Operaciones Totales -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-700">
            <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Operaciones Totales</h3>
            <p class="text-3xl font-bold text-white mt-2">{{ stats.total_trades }}</p>
            <span class="text-gray-500 text-sm font-medium">Trades ejecutados</span>
        </div>

        <!-- Tarjeta de Trades Ganadores -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-700">
            <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Trades Ganadores</h3>
            <p class="text-3xl font-bold text-white mt-2">{{ stats.trades_ganadores }}</p>
            <span class="text-gray-500 text-sm font-medium">Operaciones con PNL positivo</span>
        </div>
    </div>

    <!-- Gráfica de Avance -->
    <div class="bg-gray-800 rounded-lg p-6 shadow-lg border border-gray-700 mb-8">
        <h2 class="text-xl font-semibold text-white mb-4">Avance de Capital (PNL Acumulado)</h2>
        {% if trades %}
            <canvas id="pnlChart"></canvas>
        {% else %}
            <p class="text-gray-400">No hay suficientes datos para mostrar la gráfica. Activa el bot para empezar.</p>
        {% endif %}
    </div>

    <!-- Historial de Operaciones -->
    <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700 overflow-hidden">
        <h2 class="text-xl font-semibold text-white p-6">Historial de Operaciones</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-700">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Timestamp</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Activo</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Tipo</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Precio</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">PNL ($)</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">PNL Acumulado ($)</th>
                    </tr>
                </thead>
                <tbody class="bg-gray-800 divide-y divide-gray-700">
                    {% if trades %}
                        {% for trade in trades|reverse %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">{{ trade.timestamp }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-white font-medium">{{ trade.asset }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                {% if trade.type == 'buy' %}
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-900 text-green-300">Compra</span>
                                {% else %}
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-900 text-red-300">Venta</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${{ "%.2f"|format(trade.price) }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm {% if trade.pnl > 0 %}text-green-500{% elif trade.pnl < 0 %}text-red-500{% else %}text-gray-400{% endif %}">
                                {{ "%.2f"|format(trade.pnl) }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-white font-bold">
                                {{ "%.2f"|format(trade.pnl_acumulado) }}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                No hay operaciones en el historial.
                                <br>
                                <span class="text-sm">Ve al Dashboard para activar tu bot e iniciar el trading automático.</span>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', (event) => {
    // Solo intenta crear la gráfica si hay datos
    const labels = {{ labels|tojson }};
    if (labels.length > 0) {
        const ctx = document.getElementById('pnlChart').getContext('2d');
        
        // Gradiente para la línea
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); // color azul
        gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

        const pnlData = {{ pnl_data|tojson }};
        
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'PNL Acumulado ($)',
                    data: pnlData,
                    borderColor: 'rgba(59, 130, 246, 1)', // Azul sólido
                    backgroundColor: gradient, // Relleno con gradiente
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    fill: 'origin', // Rellenar hasta el eje X
                    tension: 0.1 // Línea ligeramente curvada
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            color: '#9CA3AF', // Color de los números del eje Y
                            callback: function(value, index, values) {
                                return '$' + value;
                            }
                        },
                        grid: {
                            color: '#374151' // Color de las líneas de la cuadrícula
                        }
                    },
                    x: {
                        ticks: {
                            color: '#9CA3AF', // Color de las etiquetas del eje X
                            maxTicksLimit: 10 // Mostrar menos etiquetas para que no se saturen
                        },
                        grid: {
                            color: '#374151' // Color de las líneas de la cuadrícula
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#D1D5DB' // Color de la leyenda
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1F2937',
                        titleColor: '#F9FAFB',
                        bodyColor: '#E5E7EB',
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>

{% endblock %}